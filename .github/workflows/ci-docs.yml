name: CI + Publish Reports

on:
  push:
    branches: ["main"]
  pull_request:

permissions:
  contents: write

env:
  COURSE_GUARD_ENABLED: ${{ vars.COURSE_GUARD_ENABLED || 'true' }}

jobs:
  build_test_publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --------------------------------------------------
      # Guard: alumnos solo pueden modificar student/
      # --------------------------------------------------
      - name: "Guard: only student/ changes allowed"
        if: env.COURSE_GUARD_ENABLED == 'true'
        shell: bash
        env:
          EVENT_NAME: ${{ github.event_name }}
          PR_BASE_SHA: ${{ github.event.pull_request.base.sha }}
          PR_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          PUSH_BEFORE_SHA: ${{ github.event.before }}
          PUSH_SHA: ${{ github.sha }}
        run: |
          set -euo pipefail

          if [ "$EVENT_NAME" = "pull_request" ]; then
            BASE_SHA="$PR_BASE_SHA"
            HEAD_SHA="$PR_HEAD_SHA"
          else
            BASE_SHA="$PUSH_BEFORE_SHA"
            HEAD_SHA="$PUSH_SHA"
          fi

          if [ "$BASE_SHA" = "0000000000000000000000000000000000000000" ]; then
            echo "Initial push detected; skipping guard."
            exit 0
          fi

          CHANGED_FILES="$(git diff --name-only "$BASE_SHA" "$HEAD_SHA" || true)"
          if [ -z "$CHANGED_FILES" ]; then
            echo "No changed files."
            exit 0
          fi

          VIOLATIONS="$(echo "$CHANGED_FILES" | grep -vE '^student/' || true)"
          if [ -n "$VIOLATIONS" ]; then
            echo "ERROR: Only changes under student/ are allowed."
            echo "$VIOLATIONS"
            exit 1
          fi

          echo "Guard OK."

      # --------------------------------------------------
      # Tooling
      # --------------------------------------------------
      - name: Install dependencies (without doxygen)
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake g++ lcov graphviz python3

      - name: Install Doxygen 1.14.0
        run: |
          set -euxo pipefail
          wget -q https://www.doxygen.nl/files/doxygen-1.14.0.linux.bin.tar.gz
          tar -xzf doxygen-1.14.0.linux.bin.tar.gz
          sudo mv doxygen-1.14.0/bin/doxygen /usr/local/bin/doxygen
          doxygen --version

      # --------------------------------------------------
      # Prepare directories (match local workflow)
      # --------------------------------------------------
      - name: Prepare directories
        run: |
          set -euxo pipefail
          rm -rf build site tmp
          mkdir -p tmp site/coverage site/tests

      # --------------------------------------------------
      # Configure / Build (coverage enabled)
      # --------------------------------------------------
      - name: Configure (coverage)
        run: |
          set -euxo pipefail
          cmake -S . -B build \
            -DENABLE_TESTING=ON \
            -DENABLE_COVERAGE=ON \
            -DCMAKE_BUILD_TYPE=Debug \
            --log-level=ERROR

      - name: Build
        run: |
          set -euxo pipefail
          cmake --build build --parallel

      # --------------------------------------------------
      # Run tests + generate JUnit XML (ctest.xml)
      # --------------------------------------------------
      - name: Run unit tests (with JUnit XML)
        run: |
          set -euxo pipefail
          ctest --test-dir build \
                --output-junit "../tmp/ctest.xml" \
                --output-on-failure

      # --------------------------------------------------
      # Coverage: capture, filter, extract, HTML (like local script)
      # --------------------------------------------------
      - name: Generate coverage report
        run: |
          set -euxo pipefail

          BUILD_DIR="build"
          TMP_DIR="tmp"
          COVERAGE_SITE_DIR="site/coverage"

          echo "▶ Capturing coverage (lcov)..."
          lcov --quiet \
            --directory "${BUILD_DIR}" \
            --capture \
            --output-file "${TMP_DIR}/coverage.raw.info" \
            --rc derive_function_end_line=0 \
            --ignore-errors inconsistent,unsupported,format,unused,mismatch

          echo "▶ Filtering coverage..."
          lcov --quiet \
            --remove "${TMP_DIR}/coverage.raw.info" \
              '/usr/*' \
              '*/_deps/*' \
              '*/course/tests/*' \
              '*/student/tests/*' \
            --output-file "${TMP_DIR}/coverage.filtered.info" \
            --ignore-errors unused

          echo "▶ Extracting course-related coverage..."
          lcov --quiet \
            --extract "${TMP_DIR}/coverage.filtered.info" \
              '*course/src/*' \
              '*course/include/*' \
              '*student/src/*' \
              '*student/include/*' \
            --output-file "${TMP_DIR}/coverage.final.info" \
            --ignore-errors unused

          echo "▶ Generating HTML coverage report..."
          genhtml "${TMP_DIR}/coverage.final.info" \
            --output-directory "${COVERAGE_SITE_DIR}" \
            --quiet

          echo "✔ Coverage generated at ${COVERAGE_SITE_DIR}/index.html"

      # --------------------------------------------------
      # HTML test report via scripts/private/render_ctest_report.py
      # --------------------------------------------------
      - name: Generate HTML test report
        run: |
          set -euxo pipefail
          TESTS_SITE_DIR="site/tests"

          echo "▶ Generating HTML test report..."
          python3 scripts/private/render_ctest_report.py \
            "tmp/ctest.xml" \
            "${TESTS_SITE_DIR}/index.html"
          echo "✔ Test report generated at ${TESTS_SITE_DIR}/index.html"

      # --------------------------------------------------
      # Run Doxygen (assumes Doxyfile already configured)
      # --------------------------------------------------
      - name: Run Doxygen
        run: |
          set -euxo pipefail
          echo "▶ Running Doxygen..."
          doxygen docs/Doxyfile
          echo "✔ Doxygen documentation generated"

      # --------------------------------------------------
      # Landing page (match local site/index.html)
      # --------------------------------------------------
      - name: Create site index
        run: |
          set -euxo pipefail
          printf '%s\n' \
            '<!DOCTYPE html>' \
            '<html lang="es">' \
            '<head>' \
            '  <meta charset="utf-8" />' \
            '  <title>Curso C++</title>' \
            '</head>' \
            '<body>' \
            '  <h1>Curso C++</h1>' \
            '  <ul>' \
            '    <li><a href="coverage/index.html">Cobertura de código</a></li>' \
            '    <li><a href="tests/index.html">Reporte de tests</a></li>' \
            '    <li><a href="docs/html/index.html">Documentación Doxygen</a></li>' \
            '  </ul>' \
            '</body>' \
            '</html>' \
            > site/index.html

      # --------------------------------------------------
      # Debug: list site tree (opcional, pero útil)
      # --------------------------------------------------
      - name: Debug site tree
        run: |
          echo "===== site/ files (maxdepth 3) ====="
          find site -maxdepth 3 -type f | sort || true

      # --------------------------------------------------
      # Publish to GitHub Pages
      # --------------------------------------------------
      - name: Publish to GitHub Pages
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: site
          publish_branch: gh-pages
